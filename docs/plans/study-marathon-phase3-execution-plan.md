# Study Marathon Phase 3 実行計画書（ユーザー管理 & ログイン）

本ドキュメントは、`docs/plans/study-marathon-mvp-execution-plan.md` の Phase 3 を詳細化し、実装タスクをチェックボックス形式で管理するための実行計画書です。

---

## 1. Phase概要

- **Phase名**
  - Phase 3: ユーザー管理 & ログイン (Spring Security導入)

- **目的**
  - 要件定義の「U-01 新規登録」「U-02 ログイン」を実装し、学習記録とユーザーを紐付けられる状態にする。

- **スコープ**
  - ユーザー登録画面
  - ログイン画面
  - Spring Security 設定
  - パスワードのハッシュ化 (BCrypt)

- **完了条件(ハイレベル)**
  - `/login` 画面で「ログイン」「新規登録」タブを切り替え可能になっている
  - 新規ユーザー登録ができ、そのユーザーでログインできる
  - ログイン後のみ、学習記録関連画面(Phase2までで作成した画面)にアクセス可能になっている

---

## 2. 事前確認・準備タスク

- [ ] P3-01: Phase2 までのブランチ/実装状況を確認する
- [ ] P3-02: Phase3 用の作業ブランチ `issue/phase3-user-auth` を作成する
- [ ] P3-03: 要件定義書の「U-01 新規登録」「U-02 ログイン」項目を再確認する
- [ ] P3-04: 既存の `Users` Entity と DBスキーマ(カラム構成)を確認する
- [ ] P3-05: 現状の Spring Security 設定状況(有効/無効、設定クラスの有無)を確認する

---

## 3. ドメイン・モデル/Repository周りの整備

- [ ] P3-10: `Users` Entity に Spring Security 用の情報が十分か確認する
  - 例: `username`, `password`, `enabled` など
- [ ] P3-11: ログイン処理で利用する `UserRepository` (または相当クラス) のインターフェースを定義/整理する
  - [ ] `findByUsername` など、認証に必要なメソッドを用意
- [ ] P3-12: 既存のマイグレーション(H2 初期データなど)との整合性を確認する

---

## 4. Spring Security 基盤実装

### 4-1. UserDetails / UserDetailsService 実装

- [ ] P3-20: Spring Security 依存関係が pom.xml に設定されているか確認
- [ ] P3-21: `UserDetails` を実装したクラスを作成する
  - [ ] Users Entity から `UserDetails` への変換方針を決める
  - [ ] 権限(ROLE_USER など)の扱いを決める（固定で良いか、将来拡張を見据えるか）
- [ ] P3-22: `UserDetailsService` を実装する
  - [ ] `loadUserByUsername` で `UserRepository` からユーザーを取得
  - [ ] ユーザー未存在時の例外ハンドリングを実装

### 4-2. SecurityConfig の作成

- [ ] P3-30: セキュリティ設定クラス（例: `SecurityConfig`）を作成
- [ ] P3-31: 認可ルールの定義
  - [ ] `/login`, `/register` (または `/auth/**`) などは未ログインでもアクセス可能に設定
  - [ ] 学習記録系の URL はログイン必須に設定
- [ ] P3-32: ログインページ設定
  - [ ] カスタムログインページ(`/login`)を設定
  - [ ] ログイン成功時の遷移先(例: ホーム or 学習記録画面)を決める
- [ ] P3-33: ログアウト設定
  - [ ] ログアウトURL, ログアウト後の遷移先などの定義

---

## 5. 認証画面(ログイン/新規登録)のUI実装

### 5-1. コントローラ層

- [ ] P3-40: 認証用 Controller クラスを新規作成（例: `AuthController`）
- [ ] P3-41: `/login` GET でログイン/新規登録タブ付き画面を返す
- [ ] P3-42: 新規登録 POST エンドポイント(例: `/register`) を定義
  - [ ] 入力バリデーション(必須項目、パスワードの最小長など)を実装

### 5-2. Thymeleaf テンプレート

- [ ] P3-50: `/login` 画面テンプレート作成
  - [ ] 「ログイン」タブ UI を実装 (username / password 入力フォーム)
  - [ ] Spring Security のデフォルトパラメータ (`username`, `password`) か、カスタムかを決める
- [ ] P3-51: 「新規登録」タブ UI を実装
  - [ ] username / password / password(確認) などの項目を定義
- [ ] P3-52: ログイン失敗/バリデーションエラー時のエラーメッセージ表示領域を用意

---

## 6. 新規登録処理(パスワードハッシュ化含む)

- [ ] P3-60: BCryptPasswordEncoder の Bean 定義を Security 設定に追加
- [ ] P3-61: 新規登録時の Service 層(例: `UserRegistrationService`) を実装
  - [ ] 生パスワードを BCrypt でハッシュ化して保存
  - [ ] 既存ユーザー名との重複チェック
- [ ] P3-62: 登録後の遷移先を決める
  - [ ] 登録完了メッセージを表示し、ログインタブへ戻す or 自動ログインして遷移する

---

## 7. 既存画面との連携(学習記録画面への制御)

- [ ] P3-70: Phase2 で作成した学習記録 CRUD 画面の URL を洗い出す
- [ ] P3-71: 上記 URL へのアクセスをログイン必須に変更（SecurityConfig のパス設定）
- [ ] P3-72: 未ログイン状態でアクセスした場合 `/login` へリダイレクトされることを確認
- [ ] P3-73: ログイン成功後に学習記録画面へスムーズに遷移できるようにする

---

## 8. 動作確認シナリオ (UI確認ポイントを細分化)

- [ ] P3-80: `/login` 画面で「ログイン」「新規登録」タブを切り替えられること
- [ ] P3-81: 新規ユーザー登録フローの確認
  - [ ] 未登録ユーザー情報で新規登録
  - [ ] DB(H2 Console など)でユーザーが保存されていることを確認
  - [ ] 保存されたパスワードがハッシュ化されていることを確認
- [ ] P3-82: 登録したユーザーでのログイン確認
  - [ ] 正しいパスワードでログイン成功する
  - [ ] 誤ったパスワードでエラーメッセージが表示される
- [ ] P3-83: ログイン状態で学習記録画面へアクセス可能なこと
- [ ] P3-84: 未ログイン状態で学習記録画面URLへ直接アクセスした際 `/login` へリダイレクトされること
- [ ] P3-85: ログアウト操作でセッションが切れ、再度学習記録画面にアクセスすると `/login` に戻されること

---

## 9. 後続Phase(Phase4以降)への引き継ぎメモ

- [ ] P3-90: ログインユーザーIDを取得するためのヘルパー or 共通メソッドを定義し、Phase4(ユーザー紐付け)で利用できるようにしておく
- [ ] P3-91: 追加で必要になりそうなユーザー属性(表示名など)があればメモしておく

---

## 10. 振り返り/ToDo残

- [ ] P3-99: Phase3 実装完了後に、本ドキュメント上のチェック状況を更新し、残タスクを洗い出す
