# Study Marathon Phase4 実行計画書（学習記録機能のユーザー紐付け & マイページ）

本ドキュメントは、`docs/plans/study-marathon-mvp-execution-plan.md` の **Phase 4** を詳細化した実行計画です。

---

## 1. Phase4のゴール定義

- **目的**
  - ログインユーザーごとに学習記録を保持し、要件定義の「S-02 自分の記録一覧」を完成させる。

- **スコープ**
  - ログインユーザーに紐づいた学習記録登録
  - ログインユーザーの記録のみを表示するマイページ(一覧画面)
  - 自分の記録のみ削除できるようにする

- **UI確認ポイント**
  - ユーザーAでログインして登録した記録は、ユーザーBでログインしても見えない。
  - マイページ(記録一覧画面)で、自分のログの一覧と削除ボタンのみが表示される。

---

## 2. 前提条件の確認タスク

- [ ] Phase2 で学習記録CRUD(ユーザー紐付けなし)が動作していることを確認する
- [ ] Phase3 でユーザー登録/ログイン(Spring Security)が完了していることを確認する
- [ ] `Users` / `StudyLogs` のEntityとリレーションが定義されていることを確認する
- [ ] ログイン後に遷移するベース画面(またはダッシュボード/トップ)の動線を確認する

---

## 3. ドメイン/データモデル設計タスク

- [ ] `StudyLogs` と `Users` の関連(多対一)の実装方針を確認する
  - [ ] JPAアノテーション(`@ManyToOne`, `@JoinColumn(name = "user_id")` など)の有無/書き方を決める
  - [ ] 既存データ(ユーザー紐付けなしのレコード)の扱い方針を決める
- [ ] 「ログインユーザー=記録の所有者」というルールを明文化し、コメント or ドキュメントにメモする

---

## 4. ログインユーザー情報取得処理の実装タスク

- [ ] ログインユーザー情報を取得するためのユーティリティ/仕組みを決める
  - [ ] `SecurityContextHolder` から `Authentication` を取得する方法の確認
  - [ ] `UserDetails` 実装クラス から `Users` Entity を取得するパターンの整理
- [ ] サービス層で現在ログイン中の `Users` を取得できるメソッドを用意する
  - [ ] 例: `UserService` などに `getCurrentUser()` を定義する方針検討
  - [ ] 実装 & 単体レベルでの動作確認(ログ出力など)

---

## 5. 学習記録登録時のユーザー自動紐付けタスク

- [ ] 学習記録登録のフローを洗い出す
  - [ ] どのControllerメソッドで登録処理を行っているか確認
  - [ ] どのServiceメソッドで `StudyLogs` を保存しているか確認
- [ ] 登録時に `user_id` を自動セットするように修正
  - [ ] Controller から Service に渡すDTO/Formにユーザー情報を持たせるか、Service側でログインユーザーを取得するか方針決定
  - [ ] `StudyLogs` 生成時に `setUser(currentUser)` する実装を追加
  - [ ] 既存の非ログイン前提登録ロジックがあれば削除 or ログイン前提に変更
- [ ] 動作確認
  - [ ] ユーザーAでログインして1件登録 → DBで `user_id` がAのIDになっていることを確認
  - [ ] ユーザーBでログインして1件登録 → DBで `user_id` がBのIDになっていることを確認

---

## 6. マイページ(自分の記録一覧)画面実装タスク

### 6-1. URL/コントローラ設計

- [ ] マイページのURLパスを決める (例: `/mypage/logs` など)
- [ ] Controllerにマイページ用のハンドラメソッドを追加
  - [ ] ログイン必須のパスになるようにSecurityConfigの設定を確認

### 6-2. サービス/リポジトリ実装

- [ ] ログインユーザーの記録一覧を取得するRepositoryメソッドを実装
  - [ ] 例: `findByUserOrderByStudyDateDesc(Users user)` など
- [ ] サービス層で「現在ログイン中のユーザーの記録一覧」を返すメソッドを実装
  - [ ] ページング or 全件取得の方針を決める(とりあえず全件でOKか検討)

### 6-3. Thymeleafテンプレート実装

- [ ] マイページ用テンプレートファイルを作成 (例: `mypage/log-list.html`)
- [ ] 以下の項目をテーブル表示
  - [ ] 日付
  - [ ] 学習時間(分)
  - [ ] 内容
  - [ ] 削除ボタン
- [ ] ログインユーザー名/一言メッセージなどのヘッダー表示を検討(任意)

### 6-4. 動作確認

- [ ] ユーザーAでログイン → マイページにAの記録のみが表示される
- [ ] ユーザーBでログイン → マイページにBの記録のみが表示される
- [ ] URL直叩きで未ログインアクセスした場合、ログインページにリダイレクトされる

---

## 7. 自分の記録のみ削除できるようにするタスク

- [ ] 削除処理のエンドポイント/フローを確認
  - [ ] どのControllerメソッドが削除を担当しているか
  - [ ] どのService/Repositoryメソッドを使っているか
- [ ] 「自分の記録のみ削除可能」というビジネスルールを実装
  - [ ] 削除対象の `StudyLogs` を取得
  - [ ] `studyLog.user.id == currentUser.id` であることをチェック
  - [ ] 異なる場合は削除せず、例外 or エラーメッセージを返す(実装方針を決める)
- [ ] UI上でも「自分の記録だけに削除ボタンが出ている」状態を担保
  - [ ] テンプレートでループ中のログの所有者と現在ユーザーを比較して削除ボタン表示制御を検討
- [ ] 動作確認
  - [ ] ユーザーA/Bを使い分けて、他人のレコードを削除できないことを確認

---

## 8. セキュリティ/アクセス制御の確認タスク

- [ ] `SecurityConfig` で学習記録関連URLがログイン必須になっているか確認
- [ ] H2 Consoleアクセスなど、開発用設定との干渉がないか確認
- [ ] CSRF設定とフォームの`th:action`/`_csrf` hidden項目が正しく動作しているか確認

---

## 9. テスト・検証タスク

- [ ] テスト観点整理
  - [ ] 正常系: A/Bユーザーでの登録〜一覧〜削除の一連の流れ
  - [ ] 異常系: 未ログインアクセス、他人の記録削除試行
- [ ] 簡易なテストコード or 手動テスト手順書を作成(任意)
- [ ] UI確認ポイントのチェック
  - [ ] ユーザーA/Bでの見え方の差を画面キャプチャに残す(任意)

---

## 10. 後続Phaseへの引き継ぎ観点

- [ ] Phase5(ホーム画面 & 今週の学習合計)で再利用できるメソッド/クエリを整理
- [ ] 今後のダッシュボードでマイページとどう連携するか簡易メモを残す
