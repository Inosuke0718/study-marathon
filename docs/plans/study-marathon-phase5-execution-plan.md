# Study Marathon Phase5 実行計画書（ホーム画面(ダッシュボード) & 今週の学習合計）

本ドキュメントは、`docs/plans/study-marathon-mvp-execution-plan.md` の **Phase 5** を詳細化した実行計画です。

---

## 1. Phase5 のゴール定義

- **目的**
  - 要件定義の「ホーム画面(ダッシュボード)」「自分の週間合計表示」を実現する。

- **スコープ**
  - ログイン後に表示されるダッシュボード画面
  - 今週の自分の学習時間合計の計算・表示
  - ダッシュボード上に学習記録入力フォームを配置

- **UI確認ポイント(ゴール)**
  - ログイン後に表示されるホーム画面上部に「今週の学習時間：XX時間YY分」と表示される。
  - 同じ画面のフォームから記録を登録すると、その場で今週の合計時間が更新される。

---

## 2. 前提条件の確認タスク

- [x] Phase2 で学習記録CRUD(ユーザー紐付けなし)が動作していることを確認する
- [x] Phase3 でユーザー登録/ログイン(Spring Security)が完了していることを確認する
- [x] Phase4 で「ログインユーザーに紐づいた学習記録登録 & マイページ(一覧)」が概ね動作していることを確認する
- [x] ログイン後の遷移先(現状のトップ or マイページ)の動線を確認し、Phase5での「ホーム画面」の位置付けを決める

---

## 3. ドメイン/データ取得方針の設計タスク

- [x] 「今週」の定義を明確化する
  - [x] 「今週の月曜 0:00 ～ 現在」か、「直近7日間」かを決定する(基本はMVP計画どおり月曜〜現在)
  - [x] タイムゾーン(日本時間 JST 前提)で扱うことを明文化
- [x] 週間合計計算の単位を決める
  - [x] DB上は `duration` を「分」で保持している前提で、サービス内で「時間＋分」に変換する方針とする
- [x] 期間条件付きの取得方法を検討する
  - [x] Repositoryで `studyDate` の範囲と `user` を条件に合計値を取得するクエリを用意するか検討
  - [x] もしくは該当期間のログ一覧を取得してサービス層で合計する方針を検討

---

## 4. 期間計算・サービス層実装タスク

- [x] 「今週の開始日時」と「現在日時」を求めるユーティリティ/メソッドを作成
  - [x] Java Time API (`LocalDate`, `LocalDateTime`, `DayOfWeek`, `ZoneId`) を用いた実装方針を決める
  - [x] 週の開始日(例: `LocalDate.now().with(DayOfWeek.MONDAY)`) の算出ロジックを実装
- [x] ログインユーザーの週間合計時間を返すサービスメソッドを実装
  - [x] 例: `StudyLogService` に `getWeeklyTotalMinutesForCurrentUser()` のようなメソッドを追加する方針を検討
  - [x] 内部で「現在ログイン中のユーザー」を取得し、Repository へ期間付きで問い合わせる
- [x] 取得した合計(分)を画面表示用の DTO or ViewModel に変換
  - [x] 「X時間Y分」形式へ変換する簡易ロジックを用意
  - [x] 変換処理をサービス側で行うか、Thymeleaf側で行うか方針を決める
- [x] 単体レベルの動作確認
  - [x] 任意の期間・データで合計が期待どおりになるかログ出力などで確認

---

## 5. ダッシュボード画面のURL/コントローラ設計タスク

- [x] ダッシュボードのURLパスを決める
  - [x] 例: `/dashboard` or `/home` など
  - [x] ログイン後のデフォルト遷移先(URL)として利用するか検討
- [x] Controller にダッシュボード用ハンドラメソッドを追加
  - [x] ログイン必須のパスになるように SecurityConfig の設定を確認
  - [x] ハンドラ内で「今週の合計時間」「ログインユーザー名」「ダッシュボードに必要な他の情報(後続Phaseで使うランキング枠など)」を Model に詰める
- [x] ログイン成功後の遷移設定を確認/調整
  - [x] ログイン成功時に `/dashboard` に飛ばす

---

## 6. ダッシュボード用テンプレート(Thymeleaf)実装タスク

- [x] ダッシュボード用テンプレートファイルを作成
  - [x] 例: `dashboard/index.html` など
- [x] 画面レイアウトの大枠を作成
  - [x] 上部: 「今週の学習時間：XX時間YY分」を大きめに表示
  - [x] 中部: 学習記録入力フォーム
  - [x] 下部: 週間ランキング(Phase6で実装)用のプレースホルダー領域を用意(枠のみ)
- [x] 今週合計表示パーツの実装
  - [x] Model から週間合計(分 or 時間＋分)を受け取り、見やすい形式で表示
  - [x] 0分の場合の表示文言(例: 「まだ今週の記録がありません」)を検討

---

## 7. ダッシュボード上の学習記録入力フォーム実装タスク

- [x] 既存の学習記録登録フォームの実装場所を確認
  - [x] どのController/テンプレートが現在のフォームを持っているか整理
- [x] フォームをダッシュボードに統合する方針を決定
  - [x] 既存のフォームテンプレートを流用(フラグメント化)するか
  - [x] ダッシュボード専用フォームとして新規実装するか
- [x] ダッシュボード画面から学習記録登録ができるように実装
  - [x] `th:action` と HTTPメソッド(POST)の設定
  - [x] CSRFトークン hidden フィールドの確認
  - [x] バリデーションエラー時のメッセージ表示位置を検討
- [x] 登録完了後のリダイレクト先を `/dashboard` に設定
  - [x] Post/Redirect/Get パターンで実装し、登録後に同画面へ戻る形にする
  - [x] リダイレクト後に週間合計および必要な一覧情報が再計算されることを確認

---

## 8. UI/UX 調整タスク

- [x] ダッシュボード全体のレイアウト・見た目調整
  - [x] 見出し・カード風レイアウトなど、最低限見やすい構造にする
  - [x] スマホ表示時の崩れがひどくならないよう、簡易的なレスポンシブ調整を検討(任意)
- [x] ナビゲーションとの整合性を確認
  - [x] ヘッダーやメニューに「ダッシュボード」「マイページ」などのリンクを配置するか検討
  - [x] 現在位置が分かるようなタイトル/パンくずの表示を検討(任意)

---

## 9. 動作確認・テストタスク

- [x] テスト観点整理
  - [x] 正常系: 今週の複数日にわたって記録を登録し、合計が正しいこと
  - [x] 境界系: 週をまたぐタイミング(日曜→月曜)での合計計算が期待どおりになること
  - [x] 異常系: 未ログイン状態で `/dashboard` にアクセスした場合、ログイン画面にリダイレクトされること
- [x] 手動テスト実施
  - [x] ユーザーAで複数日分の記録を登録し、ダッシュボード上の合計表示を確認
  - [x] ユーザーBでログインし、Aとは独立した合計表示になることを確認
- [x] UI確認ポイントのチェック
  - [x] ログイン後のホーム画面上部に「今週の学習時間：XX時間YY分」と表示される
  - [x] その画面のフォームから記録を登録すると、今週の合計時間が更新される

---

## 10. 後続Phase(週間ランキング)への引き継ぎ観点

- [x] Phase6(週間ランキング)で再利用できるクエリ/メソッドを整理
  - [x] 期間指定ロジック(今週の開始〜終了)を共通化できるようにしておく
- [x] ダッシュボード下部にランキング表示用のテーブル/コンテナを用意
  - [x] 現時点ではダミー文言(「週間ランキングは今後のPhaseで実装予定」)を表示しておく
- [x] ランキング実装時に必要になりそうな情報(集計単位、TOP10件の扱いなど)を簡易メモとして残す
