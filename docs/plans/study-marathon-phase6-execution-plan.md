# Study Marathon Phase6 実行計画書（週間ランキング(自動集計)）

本ドキュメントは、`docs/plans/study-marathon-mvp-execution-plan.md` の **Phase 6** を詳細化した実行計画です。

---

## 1. Phase6 のゴール定義

- **目的**
  - 要件定義の「R-01 週間ランキング」「週間ランキングTOP10」を実装し、MVPのコア価値である「競争」を実現する。

- **スコープ**
  - 今週の全ユーザーの学習時間合計の集計
  - 合計時間の降順でTOP10を表示
  - アクセス時にSQL/JPQLでリアルタイム集計(バッチ処理なし)

- **UI確認ポイント(ゴール)**
  - ホーム画面(ダッシュボード)下部に「週間ランキングTOP10」が表示される。
  - 複数ユーザーで記録を登録すると、順位と合計時間が変化することが確認できる。

---

## 2. 前提条件の確認タスク

- [ ] Phase4 で「ログインユーザーに紐づいた学習記録登録 & マイページ(一覧)」が概ね動作していることを確認する
- [ ] Phase5 で「ホーム画面(ダッシュボード) & 今週の学習合計」が概ね動作していることを確認する
- [ ] `Users` / `StudyLogs` Entity と、その間のリレーションが安定していることを確認する
- [ ] 「今週」の期間計算ロジック(Phase5で実装したもの)が問題なく動いていることを確認する
- [ ] ダッシュボードテンプレート(ランキング表示予定の領域)が既に存在することを確認する

---

## 3. ランキング要件の整理タスク

- [ ] ランキングの集計単位を明確にする
  - [ ] 集計対象期間: 「今週の月曜 0:00 ～ 現在」とする(Phase5と同じ定義を利用)
  - [ ] 集計対象: 有効な全ユーザー
- [ ] ランキングの表示仕様を決める
  - [ ] 表示件数: TOP10 を基本とする
  - [ ] 同率順位の扱い(同じ合計時間の場合の並び順)を決める
  - [ ] 未記録ユーザーはランキングに出さない方針を明文化
- [ ] 表示項目を整理する
  - [ ] 順位
  - [ ] ユーザー名(またはニックネーム)
  - [ ] 今週の学習時間合計(例: 「X時間Y分」表記)

---

## 4. ランキング用DTO / Projection 設計タスク

- [ ] ランキング行を表すDTOまたはProjectionを設計する
  - [ ] フィールド例: `rank`, `username`, `totalMinutes`
- [ ] DTO/Projection を定義する
  - [ ] Interface-based Projection を使うか、シンプルなDTOクラスを使うか方針決定
  - [ ] 必要に応じてコンストラクタ式(JPQL)でDTOを組み立てる案も検討
- [ ] フロント表示用のフォーマット方針を決める
  - [ ] `totalMinutes` を「時間+分」に変換する責務をどこに持たせるか(サービス層 or テンプレート側)
- [ ] ダミーデータを30件ほど作成して
---

## 5. Repository 層(集計クエリ)実装タスク

- [ ] 期間条件付き集計クエリを設計する
  - [ ] 対象期間: 「今週の開始日時」と「現在日時」
  - [ ] 集計内容: ユーザーごとの `duration` 合計(分)
- [ ] JPQL or Native SQL のどちらで実装するかを決める
- [ ] Repository インターフェースにランキング取得用メソッドを追加する
  - [ ] 例: `findWeeklyRanking(開始日時, 終了日時, 表示件数)` のようなシグネチャを検討
  - [ ] `GROUP BY user` + `SUM(duration)` + `ORDER BY SUM(duration) DESC` を行う
- [ ] TOP10 件のみ取得するための制限をかける
  - [ ] `Pageable` を利用するか、クエリ側で `LIMIT` を使用するか方針決定
- [ ] 実行されるSQLをログで確認し、想定どおりのクエリになっているか確認

---

## 6. サービス層(ランキング取得ロジック)実装タスク

- [ ] 期間計算ロジックを共通化/再利用する
  - [ ] Phase5 で実装した「今週の開始日時取得」の処理を利用 or 共通ユーティリティへ切り出す
- [ ] ランキング取得用サービスメソッドを実装する
  - [ ] 例: `RankingService` もしくは `StudyLogService` にランキング取得メソッドを追加する方針を検討
  - [ ] 内部で「今週の開始日時」「現在日時」を計算し、Repository の集計クエリを呼び出す
- [ ] Service 層でDTOへの変換や表示用整形を行うかどうかを決める
  - [ ] `totalMinutes` を「時間＋分」に変換する場合の処理場所を決定
- [ ] 単体レベルでの動作確認
  - [ ] テストデータを用意し、複数ユーザーに対して合計値とソート順が期待どおりになるかログ出力などで確認

---

## 7. コントローラ/ルーティング実装タスク

- [ ] ダッシュボード表示用Controller(Phase5で実装済み)を拡張する
  - [ ] ランキング取得用サービスメソッドを呼び出し、Model にランキングリストを詰める
  - [ ] Model 属性例: `weeklyRankingList` など
- [ ] ランキング表示が不要な画面(マイページ等)には影響が出ないように責務を整理する
- [ ] 必要に応じて新しいControllerメソッドを切り出すか検討する

---

## 8. ダッシュボード(Thymeleaf)ランキング表示実装タスク

- [ ] 既存のダッシュボードテンプレート(Phase5で作成済み)のランキングエリアを実装に置き換える
  - [ ] 「今後実装予定」のダミー文言を削除
  - [ ] `th:each` でランキングDTOリストをループ表示
- [ ] テーブル構造の定義
  - [ ] 列構成: 「順位」「ユーザー名」「今週の学習時間」
  - [ ] ヘッダー行の文言を決める
- [ ] 順位の表示方法を決める
  - [ ] Controller/Service側で`rank`を計算してDTOに持たせる
  - [ ] もしくは Thymeleaf のインデックス(`iterStat.index`)から算出する方針を検討
- [ ] 合計時間のフォーマットを実装
  - [ ] 「X時間Y分」形式での表示
  - [ ] 0分の場合の扱い(ランキングに出てこない想定だが、一応考慮)

---

## 9. 動作確認・テストタスク

- [ ] テスト観点整理
  - [ ] 正常系: 複数ユーザーが今週に複数回記録した場合に、合計時間と順位が正しいこと
  - [ ] 境界系: ランキング対象ユーザーが10人未満/10人超の場合の表示
  - [ ] 境界系: 週の境目(日曜→月曜)で、前週分が含まれないこと
  - [ ] 異常系: 学習ログが1件もない場合の表示(ランキングエリアの表示文言)
- [ ] 手動テスト実施
  - [ ] ユーザーA/B/Cでログインし、それぞれ異なる量の記録を登録してランキングを確認
  - [ ] 今週分と先週分のデータを混在させ、先週分が集計対象外になることを確認
- [ ] UI確認ポイントのチェック
  - [ ] ホーム画面下部に「週間ランキングTOP10」が表示される
  - [ ] 複数ユーザーで記録を登録すると、順位と合計時間が変化することを確認

---

## 10. 後続Phase(リファクタリング/運用)への引き継ぎ観点

- [ ] 期間計算ロジックや集計ロジックを、将来的に「月間ランキング」「年間ランキング」などに拡張しやすい形で整理
- [ ] 大量データになった場合のパフォーマンス懸念点をメモ
  - [ ] インデックス設計(必要であれば)
  - [ ] キャッシュ導入の検討余地
- [ ] ランキング表示に関するUI/UX改善アイデア(アイコン表示、順位色分けなど)をメモ
